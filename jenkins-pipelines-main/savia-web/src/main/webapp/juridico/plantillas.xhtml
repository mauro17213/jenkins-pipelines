<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../home.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:pe="http://primefaces.org/ui/extensions"
                >

    <ui:define name="bodyJR">
        <h:outputStylesheet name="css/cntjuridica.css"/>
        <center>
            <!-- listado de plantillas -->
            <h:form id="frmGestion" prependId="false">
                <p:toolbar>
                    <f:facet name="left" >
                        <span title="#{plantillaBean.modulo.descripcion}">#{plantillaBean.modulo.nombre}</span>
                    </f:facet>
                    <f:facet name="right">
                        <p:commandButton rendered="#{plantillaBean.accionListar}" title="Refrescar" ajax="true" actionListener="#{plantillaBean.listar}" icon="pi pi-sync" class="boton-normal btn1" />
                        <p:commandButton rendered="#{plantillaBean.accionCrear}" title="Crear" ajax="true" actionListener="#{plantillaBean.crear()}" icon="pi pi-file-o" class="boton-normal btn1" />
                    </f:facet>
                </p:toolbar>

                <p:dataTable var="obj" class="listaDatos" value="#{plantillaBean.lazyPlantillas}"  paginator="true" rows="#{procesoBean.tamanoPagina}" 
                             emptyMessage="No se encontraron registros"
                             currentPageReportTemplate="Registros del {startRecord} al {endRecord} de {totalRecords}, Página {currentPage} de {totalPages}"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="5,10,30,50,100" id="tablaRegistros" lazy="true"
                             widgetVar="tablaWidget"
                             style="font-size:11px;"
                             scrollable="false"
                             scrollWidth="140%"
                             rowKey="#{obj.id}" reflow="true">

                    <p:column headerText="Opciones" style="text-align: center;">
                        <p:commandButton rendered="#{plantillaBean.accionVer}" title="Ver" actionListener="#{plantillaBean.ver(obj.id)}" icon="pi pi-search" class="btn-icono"/>
                        <p:commandButton rendered="#{plantillaBean.accionEditar}" title="Editar" actionListener="#{plantillaBean.editar(obj.id)}" icon="pi pi-file-edit" class="btn-icono" />
                        <p:commandButton rendered="#{plantillaBean.accionAdicional2}" title="Duplicar Plantilla" actionListener="#{plantillaBean.duplicarPlantilla(obj.id)}" icon="pi pi-clone" class="btn-icono" >
                            <p:confirm header="Confirmación" 
                                       message="A continuación se duplicará la plantilla indicada, creando una nueva versión pero manteniendo los campos asociados. ¿Está seguro que desea continuar?" 
                                      />
                        </p:commandButton>
                    </p:column>

                    <p:column headerText="Nombre" filterBy="#{obj.nombre}" sortBy="#{obj.nombre}" >
                        <f:facet name="filter">
                            <p:inputText label="Nombre" class="txtFiltro" maxlength="128" onchange="PF('tablaWidget').filter()"/>
                        </f:facet>
                        <h:outputText value="#{obj.nombre}" title="#{obj.nombre}"/>
                    </p:column>

                    <p:column headerText="Descripción" >
                        <h:outputText value="#{obj.descripcion}" title="#{obj.descripcion}"/>
                    </p:column>

                    <p:column headerText="Documento" filterBy="#{obj.procesodocumentoId.nombre}" sortBy="#{obj.procesodocumentoId.nombre}" >
                        <f:facet name="filter">
                            <p:inputText label="Nombre" class="txtFiltro" maxlength="128" onchange="PF('tablaWidget').filter()"/>
                        </f:facet>
                        <h:outputText value="#{obj.procesodocumentoId.nombre}" title="#{obj.procesodocumentoId.nombre}"/>
                    </p:column>

                    <p:column headerText="Proceso" >
                        <h:outputText value="#{obj.procesodocumentoId.procesoId.nombre}" title="#{obj.procesodocumentoId.procesoId.nombre}"/>
                    </p:column>

                    <p:column headerText="Activo" sortBy="#{obj.activo}" >
                        <h:outputText value="#{obj.activoStr}" title="#{obj.activoStr}"/>
                    </p:column>

                    <p:column headerText="Versión" sortBy="#{obj.version}" >
                        <h:outputText value="#{obj.version}" title="#{obj.version}"/>
                    </p:column>

                    <p:column headerText="Fecha Creación" sortBy="#{obj.version}" >
                        <h:outputText value="#{obj.fechaHoraCrea}" title="#{obj.fechaHoraCrea}">
                            <f:convertDateTime pattern="yyyy-MM-dd" />
                        </h:outputText>
                    </p:column>

                </p:dataTable>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" style="left:25%"/>
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" style="left:25%"/>
                </p:confirmDialog>
            </h:form>

            <!-- Dialogo para ver plnatilla -->
            <p:dialog header="Ver" widgetVar="dialogoVer" appendTo="@(body)" fitViewport="true" resizable="false" styleClass="fullscreen-dialog"
                       onShow="cargarEstructura('frmVer')" >                   
                <div class="bodyDialogFull" >
                    <h:form class="frmAuditoria">
                        <p:commandButton id="auditoria" class="btnAuditoria btn-icono" action="#{plantillaBean.getAuditoria(plantillaBean.objeto.auditoriaStrHTML)}" icon="ui-icon-comment" title="Auditoría" />
                    </h:form> 
                    <h:form id="frmVer" class="formDialogo">
                        <p:scrollPanel mode="native">
                            <p:panel id="pnlInfoVer" header="Información de la plantilla" style="margin-bottom:10px;" toggleable="true">
                                <p:panelGrid id="panelVer" columns="4"
                                             columnClasses="ui-grid-col-3,ui-grid-col-3,ui-grid-col-3,ui-grid-col-3"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank ui-fluid" >

                                    <h:outputText value="Id" style="font-weight:bold" class="header-back" />
                                    <h:outputText value="#{plantillaBean.objeto.id}" />

                                    <h:outputText value="Nombre" style="font-weight:bold" class="header-back" />
                                    <h:outputText value="#{plantillaBean.objeto.nombre}" />

                                    <h:outputText value="Documento" style="font-weight:bold" class="header-back" />
                                    <h:outputText value="#{plantillaBean.objeto.procesodocumentoId.nombre} (#{plantillaBean.objeto.procesodocumentoId.procesoId.nombre})"  /> 
                                    
                                    <h:outputText value="Activo" style="font-weight:bold" class="header-back" />
                                    <h:outputText value="#{plantillaBean.objeto.activoStr}"  /> 

                                </p:panelGrid>

                                <p:panelGrid id="panelVer2" columns="2"
                                             columnClasses="ui-grid-col-3,ui-grid-col-9"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank ui-fluid" >

                                    

                                    <h:outputText value="Descripción" style="font-weight:bold" class="header-back" />
                                    <h:outputText value="#{plantillaBean.objeto.descripcion}"  />

                                </p:panelGrid>
                            </p:panel>

                            <p:panel header="Estructura" style="margin-bottom:10px; height: fit-content;" toggleable="true" >    
                                <h:inputHidden id="hiddenFormato" value="#{plantillaBean.objeto.estructura}" />
                                <pe:sunEditor id="vestructura" 
                                              height="auto" 
                                              readonly="true"
                                              width="100%" secure='false' 
                                              locale="es"   
                                              toolbar="[]"

                                              />
                            </p:panel> 
                        </p:scrollPanel>
                        <p:panelGrid class="footerdialog">
                            <f:facet name="footer">
                                <p:row>
                                    <p:column colspan="4" style="text-align: center">
                                        <h:panelGroup class="pgFooter">
                                            <p:commandButton value="Salir" class="boton btn-oscuro" type="button" onclick="PF('dialogoVer').hide()" immediate="true"/>
                                        </h:panelGroup>
                                    </p:column>
                                </p:row>
                            </f:facet>
                        </p:panelGrid>
                    </h:form>
                </div>                                
            </p:dialog>  

            <!-- Dialogo para crear nueva plantilla -->
            <p:dialog header="Crear" widgetVar="dialogoCrear" appendTo="@(body)" modal="true" fitViewport="true" resizable="false" styleClass="fullscreen-dialog" >                
                <div class="bodyDialogFull" >
                    <h:form id="frmCrear" class="formDialogo">   
                        <p:scrollPanel mode="native" >
                            <p:panel id="pnlInformacion" header="Información de la plantilla" style="margin-bottom:10px; margin-top: 0.8rem;" toggleable="true">
                                <p:panelGrid id="panelCrear" columns="4"
                                             columnClasses="ui-grid-col-3,ui-grid-col-3,ui-grid-col-3,ui-grid-col-3"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank ui-fluid" >

                                    <h:outputText value="Nombre " style="font-weight:bold" class="header-back" />
                                    <p:inputText id="ccodigo" value="#{plantillaBean.objeto.nombre}"  required="true" requiredMessage="Debe diligenciar el nombre del proceso." />

                                    <h:outputText value="Documento" style="font-weight:bold" class="header-back" />
                                    <p:selectOneMenu id="cdocumento" value="#{plantillaBean.objeto.procesodocumentoId.id}" required="false" requiredMessage="Documento: valor obligatorio" >
                                        <f:selectItem itemLabel=" -- " itemValue="#{null}" noSelectionOption="true" />
                                        <f:selectItems value="#{plantillaBean.documentosGroup}" var="proceso" itemValue="#{proceso.id}" itemLabel="#{proceso.nombre}" itemDescription="#{proceso.descripcion}" />
                                    </p:selectOneMenu>   
                                    
                                    <h:outputText value="Activo " style="font-weight:bold" class="header-back" />
                                    <p:selectBooleanButton id="blActivo" value="#{plantillaBean.objeto.activo}" onLabel="Si" offLabel="No"  onIcon="ui-icon-check" offIcon="ui-icon-close" style="width:60px" />

                                    <h:outputText value="Descripción " style="font-weight:bold" class="header-back" />
                                    <p:inputTextarea id="cdescripcion" value="#{plantillaBean.objeto.descripcion}" required="true" requiredMessage="Debe diligenciar la descripción."
                                                         rows="2" cols="140" maxlength="2048"  />

                                </p:panelGrid>

                            </p:panel>

                            <p:panel header="Estructura" style="margin-bottom:10px; height: fit-content;" toggleable="true" >

                                <h:inputHidden id="hiddenFormato" value="#{plantillaBean.objeto.estructura}" />
                                <pe:sunEditor id="cestructura" 
                                              height="auto" 
                                              width="100%" 
                                              secure='true' 
                                              required="true" 
                                              styleClass="editorSun"
                                              style="height: auto; min-height: 500px;"
                                              requiredMessage="Debe diligenciar la estructura."
                                              locale="es"
                                              toolbar="[
                                              ['font', 'fontSize', 'formatBlock'],
                                              ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
                                              ['fontColor', 'hiliteColor', 'textStyle'],
                                              ['removeFormat'],
                                              ['undo', 'redo'],
                                              ['indent', 'outdent'],
                                              ['align', 'horizontalRule', 'list', 'table', 'image']
                                              ]"
                                              />
                            </p:panel> 
                        </p:scrollPanel>


                        <p:panelGrid class="footerdialog">
                            <f:facet name="footer">
                                <p:row>
                                    <p:column colspan="4" style="text-align: center">
                                        <h:panelGroup class="pgFooter">
                                            <p:commandButton value="Guardar" class="boton btn-azul" type="button" onclick="sincronizarEstrucuraEditar('frmCrear'); guardarRemote()" validateClient="true"/>
                                            <p:remoteCommand name="guardarRemote" action="#{plantillaBean.guardar()}" process="@all" update="frmCrear, pnlInformacion" />
                                            <p:commandButton value="Salir" class="boton btn-oscuro" type="button" onclick="PF('dialogoCrear').hide()" immediate="true"/>
                                        </h:panelGroup>
                                    </p:column>
                                </p:row>
                            </f:facet>
                        </p:panelGrid>
                    </h:form>
                </div>                
            </p:dialog>

            <!-- Dialogo para editar plantilla -->
            <p:dialog header="Editar" widgetVar="dialogoEditar" appendTo="@(body)" modal="true" fitViewport="true" resizable="false"
                      styleClass="fullscreen-dialog"  onShow="cargarEstructura('frmEditar')" >                
                <div class="bodyDialogFull" >
                    <h:form class="frmAuditoria" >
                        <p:commandButton id="auditoria" class="btnAuditoria btn-icono" action="#{plantillaBean.getAuditoria(plantillaBean.objeto.auditoriaStrHTML)}" icon="ui-icon-comment" title="Auditoría" />
                    </h:form> 
                    <h:form id="frmEditar" class="formDialogo">  
                        <p:scrollPanel mode="native">
                            <p:panel id="pnlEditInformacion" header="Información de la plantilla" style="margin-bottom:10px;" toggleable="true">
                                <p:panelGrid id="panelCrear" columns="4"
                                             columnClasses="ui-grid-col-3,ui-grid-col-3,ui-grid-col-3,ui-grid-col-3"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank ui-fluid" >

                                    <h:outputText value="Nombre " style="font-weight:bold" class="header-back" />
                                    <p:inputText id="ecodigo" value="#{plantillaBean.objeto.nombre}"  required="true" requiredMessage="Debe diligenciar el nombre del proceso." />

                                    <h:outputText value="Documento" style="font-weight:bold" class="header-back" />
                                    <p:selectOneMenu id="cdocumento" value="#{plantillaBean.objeto.procesodocumentoId.id}" required="false" requiredMessage="Documento: valor obligatorio" >
                                        <f:selectItem itemLabel=" -- " itemValue="#{null}" noSelectionOption="true" />
                                        <f:selectItems value="#{plantillaBean.documentosGroup}" var="proceso" itemValue="#{proceso.id}" itemLabel="#{proceso.nombre}" itemDescription="#{proceso.descripcion}" />
                                    </p:selectOneMenu>
                                    
                                    <h:outputText value="Activo " style="font-weight:bold" class="header-back" />
                                    <p:selectBooleanButton id="blActivo" value="#{plantillaBean.objeto.activo}" onLabel="Si" offLabel="No"  onIcon="ui-icon-check" offIcon="ui-icon-close" style="width:60px" />

                                    <h:outputText value="Descripción " style="font-weight:bold" class="header-back" />
                                    <p:inputTextarea id="edescripcion" value="#{plantillaBean.objeto.descripcion}" required="true" requiredMessage="Debe diligenciar la descripción."
                                                         rows="2" cols="140" maxlength="2048"  />
                                    
                                </p:panelGrid>



                            </p:panel>

                            <p:panel header="Estructura" style="margin-bottom:10px; height: fit-content;" toggleable="true" >
                                <div align="right" style="margin-bottom: .4rem;"> 
                                    <p:commandButton rendered="#{plantillaBean.accionAdicional1}" class="btn-icono" title="Agregar campo" value="Agregar campo"  action="#{plantillaBean.listaCamposAgregar()}"  
                                                     process="@this" icon="pi pi-file-o"/>
                                </div>
                                <h:inputHidden id="hiddenFormato" value="#{plantillaBean.objeto.estructura}" />
                                <pe:sunEditor id="cestructura" 
                                              height="auto" 
                                              width="100%" 
                                              secure='true' 
                                              locale="es"                                              
                                              toolbar="[
                                              ['font', 'fontSize', 'formatBlock'],
                                              ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
                                              ['fontColor', 'hiliteColor', 'textStyle'],
                                              ['removeFormat'],
                                              ['undo', 'redo'],
                                              ['indent', 'outdent'],
                                              ['align', 'horizontalRule', 'list', 'table', 'image']
                                              ]"
                                              />
                            </p:panel> 

                        </p:scrollPanel>
                        <p:panelGrid class="footerdialog">
                            <f:facet name="footer">
                                <p:row>
                                    <p:column colspan="4" style="text-align: center">
                                        <h:panelGroup class="pgFooter">
                                            <p:commandButton value="Modificar" class="boton btn-azul" type="button" onclick="sincronizarEstrucuraEditar('frmEditar'); modificarRemote()" validateClient="true"/>
                                            <p:remoteCommand name="modificarRemote" action="#{plantillaBean.modificar()}" process="@all" update="pnlEditInformacion" />
                                            <p:commandButton value="Salir" class="boton btn-oscuro" type="button" onclick="PF('dialogoEditar').hide()" immediate="true"/>
                                        </h:panelGroup>
                                    </p:column>
                                </p:row>
                            </f:facet>
                        </p:panelGrid>
                    </h:form>
                </div>   
            </p:dialog>

            <!-- Dialogo para agregar campo -->
            <p:dialog header="Agregar Campo" widgetVar="dialogoAgregaCampo" appendTo="@(body)" modal="true"  resizable="false"   width="60%" dynamic="true">                
                <div class="bodyDialog200" >
                    <h:form id="frmAgregaCampo" class="formDialogo">   
                        <p:scrollPanel mode="native">
                            <p:panel id="pnlInfoCampo" header="Información del campo" style="margin-bottom:10px;" toggleable="false">
                                <p:panelGrid id="panelCrear" columns="4"
                                             columnClasses="ui-grid-col-3,ui-grid-col-3,ui-grid-col-3,ui-grid-col-3"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank ui-fluid" >

                                    <h:outputText value="Campo" style="font-weight:bold" class="header-back" />
                                    <p:column class="ui-grid-col-9" >
                                        <p:selectOneMenu id="cagregar" value="#{plantillaBean.objetoCampo.etiqueta}" filter="true" filterMatchMode="contains">
                                            <f:selectItem itemLabel=" -- " itemValue="#{null}" noSelectionOption="true" />  
                                            <f:selectItems value="#{plantillaBean.listaCampos}" var="cam" itemLabel="#{cam.nombre}" itemValue="#{cam.etiqueta}" />
                                        </p:selectOneMenu>
                                    </p:column>


                                </p:panelGrid>

                            </p:panel>

                        </p:scrollPanel>


                        <p:panelGrid class="footerdialog">
                            <f:facet name="footer">
                                <p:row>
                                    <p:column colspan="4" style="text-align: center">
                                        <h:panelGroup class="pgFooter">
                                            <p:commandButton value="Copiar Etiqueta" class="boton btn-azul" type="button" onclick="agregarCampoRemote()" validateClient="true"/>
                                            <p:remoteCommand name="agregarCampoRemote" action="#{plantillaBean.agregarCampo()}" process="@all" update="frmAgregaCampo, pnlInfoCampo" />
                                            <p:commandButton value="Salir" class="boton btn-oscuro" type="button" onclick="PF('dialogoAgregaCampo').hide()" immediate="true"/>
                                        </h:panelGroup>
                                    </p:column>
                                </p:row>
                            </f:facet>
                        </p:panelGrid>
                    </h:form>
                </div>

            </p:dialog>


            <h:outputScript target="head">
                function editorOptions() {
                    return {
                        attributesWhitelist: {
                            td: 'rowspan colspan style class',
                            th: 'rowspan colspan style class',
                            table: 'border cellpadding cellspacing style class',
                            tr: 'style class'
                        },
                        // Desactiva la limpieza automática que está causando el problema
                        addTagsWhitelist: 'table tbody tr td th div',
                        disableHtmlSanitizer: true                        
                    };
                }
                
                function cargarEstructura(formId){
                    var form = document.getElementById(formId);
                    if (form) {
                        var editor = form.querySelector('.sun-editor-editable');
                        if (editor) {
                            var valor = document.getElementById(formId+":hiddenFormato").value;
                            editor.innerHTML = valor;
                        }
                    }                    
                }
                
            </h:outputScript>
            
            <script type="text/javascript">
                function copyTextToClipboard(textToCopy) {
                    // Crea un elemento temporal para seleccionar y copiar el texto
                    var tempInput = document.createElement('textarea');
                    tempInput.value = textToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                }
                
                function sincronizarEstrucuraEditar(formId){
                    var form = document.getElementById(formId);
                    if (form) {
                        var editor = form.querySelector('.sun-editor-editable');
                        if (editor) {
                            var valor = editor.innerHTML;
                            document.getElementById(formId+":hiddenFormato").value = valor;
                        }
                    }
                    
                    /*var valor = document.getElementById(formId+":cestructura").value;
                    console.log(formId+"-"+valor);
                    document.getElementById(formId+":hiddenFormato").value = valor; */
                }
                
                
                
            </script>

        </center>

    </ui:define>

</ui:composition>
